<!DOCTYPE html>
<html lan="en">

    <head>
        <% include ../partials/head %>
        <link rel="stylesheet" href="/css/signup.css">
    </head>

    <body>
        <% include ../partials/header %>

        <div ng-app="signup" ng-controller="signupCtrl" class="container">
            <div class="row">
                <div class="panel panel-primary">
                    <div class="panel-body">
                        <form name="addUser" role="form" novalidate class="signup-form " ng-class="{submitted:addUser.submitted}" ng-submit="create(user)">
                            <div class="form-group">
                                <h2>Create account</h2>
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="fname">First Name</label>

                                <input type="text" maxlength="50" class="form-control" name="fname" ng-model="user.fname" required>
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="lname">Last Name</label>
                                <input type="text" maxlength="50" class="form-control" name="lname" ng-model="user.lname" required>
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="email">Email</label>
                                <input type="email" maxlength="50" class="form-control" name="email" ng-model="user.email" required>

                                <div ng-show="addUser.email.$invalid && addUser.email.$touched">
                                    <div class="alert alert-danger">
                                        <strong>Warning!</strong> You must enter a valid email.
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="username">Username</label>
                                <input type="text" maxlength="50" class="form-control" ng-model="user.username" name="username" username-dir required>
                                <span ng-show="addUser.username.$pending.usernameAuth">
                                    <div class="alert alert-info">
                                        Checking if username exists.
                                    </div>
                                </span>
                                <span ng-show="addUser.username.$error.usernameAuth">
                                    <div class="alert alert-danger">
                                        <strong>Warning!</strong> Username already taken,
                                    </div>
                                </span>
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="password">Password</label>
                                <input type="password" maxlength="25" class="form-control" name="password" placeholder="at least 6 characters" length="40" ng-model="user.password" required>
                            </div>
                            <div class="form-group">
                                <label class="control-label" for="passwordAgain">Retype Password</label>
                                <input name="passwordAgain" type="password" maxlength="25" class="form-control" placeholder="at least 6 characters" length="40" ng-model="user.passwordAgain" required password-dir="user.password">
                                <div ng-show="addUser.passwordAgain.$error.passwordDir">
                                    <div class="alert alert-danger">
                                        <strong>Warning!</strong> Passwords do not match!
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <input type="submit" class="btn btn-info btn-block">Create your account
                                <div ng-show="addUser.$submitted">
                                        <div ng-show="addUser.fname.$error.required || addUser.lname.$error.required || addUser.username.$error.required || addUser.email.$error.required || addUser.password.$error.required || addUser.passwordAgain.$error.required">
                                        <div class="alert alert-danger">
                                            <strong>Warning!</strong> Missing fields.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <p class="form-group">By creating an account, you agree to our <a href="/terms">Terms of Use</a> and our <a href="/privacy">Privacy Policy</a>.</p>
                            <hr>
                            <p>Already have an account? <a href="/login">Sign in</a></p>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <% include ../partials/footer %>

        <script>

            (function(angular) {
                'use strict';
                var app = angular.module('signup', []);

                app.controller('signupCtrl', ['$window', '$scope', '$http', function ($window, $scope, $http) {
                    $scope.master = {};

                    $scope.save= function (model) {
                        if ($scope.addContact.$valid) {
                            //form is valid
                        }
                        else {
                            //if form is not valid set $scope.addUser.submitted to true
                            $scope.addUser.submitted=true;
                        }};

                    $http.get("api/v1/users").then(function(response) {
                        $scope.signup = response.data.data;
                        $scope.isUsernameValid = false;
                        $scope.usernames = [];

                        for (var i = 0; i < response.data.data.length; i++) {
                            $scope.usernames.push(response.data.data[i].username);
                        }

                        $scope.create = function(user) {

                            if (user === undefined ||
                                user.fname === undefined ||
                                user.lname === undefined ||
                                user.email === undefined ||
                                user.password === undefined ||
                                user.username === undefined ||
                                user.password !== user.passwordAgain ||
                                !$scope.isUsernameValid) {
                                return false;
                            }

                            $http.post("api/v1/users", user).then(function(response) {
                                /* Redirect after user is created */
                                $window.location.href = '/';
                            });
                        }
                    });

                    $scope.create = function (user) {
                        $scope.master = angular.copy(user);
                    };
                }]);

                app.directive('usernameDir', function ($q, $timeout) {
                    return {
                        require: 'ngModel',
                        link: function (scope, elm, attrs, ctrl) {
                            ctrl.$asyncValidators.usernameAuth = function (modelValue, viewValue) {

                                if (ctrl.$isEmpty(modelValue)) {
                                    // consider empty model valid
                                    return $q.when();
                                }

                                var def = $q.defer();

                                $timeout(function () {
                                    // Mock a delayed response
                                    if (scope.usernames.indexOf(modelValue) === -1) {
                                        // The username is available
                                        def.resolve();
                                        scope.isUsernameValid = true;
                                    } else {
                                        def.reject();
                                        scope.isUsernameValid = false;
                                    }

                                }, 700);

                                return def.promise;
                            };
                        }
                    };
                });

                app.directive('passwordDir', function() {
                    return {
                        require: "ngModel",
                        scope: {
                            otherModelValue: "=passwordDir"
                        },
                        link: function(scope, element, attributes, ngModel) {

                            ngModel.$validators.passwordDir = function(modelValue) {
                                return modelValue == scope.otherModelValue;
                            };

                            scope.$watch("otherModelValue", function() {
                                ngModel.$validate();
                            });
                        }
                    };
                });

            })(window.angular);

        </script>
    </body>
</html>
